<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üìñ Bible Multiplayer Game</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding: 20px; }
    .container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    input, button { margin: 10px; padding: 10px; font-size: 1em; }
    #players, #round, #timer, #scoreboard { margin-top: 20px; }
    .score-box { display: inline-block; margin: 5px; padding: 10px; background: #eee; border-radius: 8px; text-align: center; width: 120px; }
    .player-name { font-weight: bold; }
    .player-score { font-size: 1.5em; margin-top: 5px; }
    #result { margin-top: 10px; font-weight: bold; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, updateDoc, onSnapshot, getDoc, setDoc, deleteDoc, query, collection, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let gameId = new URLSearchParams(window.location.search).get('gameId');
    let username = new URLSearchParams(window.location.search).get('username');
    let round = 1;
    let timer;
    let verseData = [];
    let currentVerse = null;
    let startTime = 0;

    window.addEventListener('DOMContentLoaded', () => {
      fetchVerseData();
      listenForGame();
    });

    async function fetchVerseData() {
      const response = await fetch('https://raw.githubusercontent.com/Sean-Pereksta/Bible-Data/main/web.csv');
      const csvText = await response.text();
      const rows = csvText.split('\n').slice(1).map(row => row.split(','));
      verseData = rows.map(r => ({ BookName: r[1], Chapter: r[3], Verse: r[4], Text: r[5] }));
    }

    function listenForGame() {
      const gameRef = doc(db, "games", gameId);
      onSnapshot(gameRef, async (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          updateScoreboard(data.scores || {});
          document.getElementById("players").innerText = `Players: ${data.players.join(", ")}`;

          if (data.status === "ended") {
            document.getElementById("verseText").innerText = "Game has ended.";
            return;
          }

          if (data.status === "waiting" && data.host === username) {
            await updateDoc(gameRef, { status: "playing", startTime: new Date().toISOString() });
          }

          if (data.status === "playing" && round === 1) {
            startTime = data.startTime ? new Date(data.startTime).getTime() : Date.now();
            await startRound(data);
          }
        }
      });
    }

    async function startRound(data) {
      if (round > 10) {
        endGame();
        return;
      }
      const gameRef = doc(db, "games", gameId);
      if (!data.currentVerse || round > 1) {
        currentVerse = verseData[Math.floor(Math.random() * verseData.length)];
        await updateDoc(gameRef, { currentVerse: currentVerse });
      } else {
        currentVerse = data.currentVerse;
      }

      document.getElementById("round").innerText = `Round: ${round}/10`;
      document.getElementById("verseText").innerText = currentVerse.Text;
      document.getElementById("result").innerText = "";

      syncTimer();

      document.getElementById("submitBtn").onclick = () => {
        evaluateAnswer();
      };
    }

    function syncTimer() {
      const now = Date.now();
      const elapsed = Math.floor((now - startTime) / 1000) % 33;
      let timeLeft = Math.max(0, 30 - elapsed);
      document.getElementById("timer").innerText = `‚è∞ ${timeLeft}s`;

      timer = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").innerText = `‚è∞ ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(timer);
          evaluateAnswer();
        }
      }, 1000);
    }

    async function evaluateAnswer() {
      clearInterval(timer);
      const book = document.getElementById("book").value.trim();
      const chapter = document.getElementById("chapter").value.trim();
      const verseNum = document.getElementById("verse").value.trim();

      let points = 0;
      let message = "";

      if (book === currentVerse.BookName) points += 1;
      if (chapter === currentVerse.Chapter) points += 3;
      if (verseNum === currentVerse.Verse) points += 5;

      if (points > 0) {
        message = `‚úÖ Correct! +${points} pts`;
      } else {
        message = `‚ùå Incorrect. Answer: ${currentVerse.BookName} ${currentVerse.Chapter}:${currentVerse.Verse}`;
      }

      const gameRef = doc(db, "games", gameId);
      const gameSnap = await getDoc(gameRef);
      const data = gameSnap.data();
      const currentScore = data.scores?.[username] || 0;

      await updateDoc(gameRef, {
        [`scores.${username}`]: currentScore + points
      });

      document.getElementById("result").innerText = message;

      setTimeout(() => {
        round++;
        startRound(data);
      }, 3000);
    }

    async function endGame() {
      const gameRef = doc(db, "games", gameId);
      await updateDoc(gameRef, { status: "ended" });

      const gameSnap = await getDoc(gameRef);
      const data = gameSnap.data();
      let winner = "";
      let highScore = 0;
      for (const [player, score] of Object.entries(data.scores || {})) {
        if (score > highScore) {
          highScore = score;
          winner = player;
        }
      }
      document.getElementById("verseText").innerText = `üéâ Game Over! Winner: ${winner} (${highScore} pts)`;
      document.getElementById("submitBtn").style.display = "none";
    }

    function updateScoreboard(scores) {
      const scoreboard = document.getElementById("scoreboard");
      scoreboard.innerHTML = "";
      for (const [player, score] of Object.entries(scores)) {
        const box = document.createElement("div");
        box.className = "score-box";
        box.innerHTML = `<div class="player-name">${player}</div><div class="player-score">${score}</div>`;
        scoreboard.appendChild(box);
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>üìñ Bible Multiplayer Game</h1>
    <div id="scoreboard"></div>
    <p id="players">Players: </p>
    <p id="round">Round: </p>
    <p id="timer">‚è∞ 30s</p>
    <p id="verseText">Waiting for game to start...</p>
    <input type="text" id="book" placeholder="Book" />
    <input type="text" id="chapter" placeholder="Chapter" />
    <input type="text" id="verse" placeholder="Verse" />
    <button id="submitBtn">Submit</button>
    <p id="result"></p>
  </div>
</body>
</html>
