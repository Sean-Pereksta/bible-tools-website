<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üèóÔ∏è Create Village</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef2f5;
      text-align: center;
      padding: 20px;
    }
    .grid-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(16, 30px);
      gap: 2px;
    }
    .cell {
      width: 30px;
      height: 30px;
      background: #fff;
      border: 1px solid #ccc;
    }
    .panel {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .building {
      width: 30px;
      height: 30px;
      border: 2px solid black;
      cursor: pointer;
    }
    .label {
      font-size: 0.8em;
      margin-top: 4px;
    }
    .option-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 60px;
    }
    #saveBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
    }
    .wall { background: black; }
    .strongWall { background: orange; }
    .archerTower { background: red; }
    .trap { background: green; }
    .lightningStriker { background: blue; }
    .troopStructure { background: purple; }
    .eraser { background: white; position: relative; }
    .eraser::after {
      content: "‚úñ";
      position: absolute;
      color: black;
      font-size: 16px;
      top: 2px;
      left: 7px;
    }
  </style>
</head>
<body>
  <h1>üèóÔ∏è Build Your Village</h1>

  <div class="panel" id="buildingOptions"></div>

  <div class="grid-wrapper">
    <div class="grid" id="villageGrid"></div>
  </div>

  <button id="saveBtn">üíæ Save Village</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const currentUsername = urlParams.get("username");

    if (!currentUsername) {
      alert("No username provided in URL.");
    }

    const buildingStats = {
      wall: { attack: 0, defense: 2 },
      strongWall: { attack: 0, defense: 5 },
      archerTower: { attack: 4, defense: 1 },
      trap: { attack: 3, defense: 3 },
      lightningStriker: { attack: 6, defense: 1 },
      troopStructure: { attack: 5, defense: 2 }
    };

    const buildingTypes = [
      { type: "wall", label: "Wall" },
      { type: "strongWall", label: "Strong Wall" },
      { type: "archerTower", label: "Archer Tower" },
      { type: "trap", label: "Trap" },
      { type: "lightningStriker", label: "Lightning" },
      { type: "troopStructure", label: "Troop House" },
      { type: "eraser", label: "Erase" }
    ];

    let selectedType = null;
    const gridSize = 16;
    const gridData = Array(gridSize).fill().map(() => Array(gridSize).fill(""));

    const buildingOptions = document.getElementById("buildingOptions");
    const gridContainer = document.getElementById("villageGrid");

    function createBuildingButtons() {
      buildingTypes.forEach(b => {
        const group = document.createElement("div");
        group.className = "option-group";

        const div = document.createElement("div");
        div.className = `building ${b.type}`;
        div.title = b.label;
        div.onclick = () => selectedType = b.type;

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = b.label;

        group.appendChild(div);
        group.appendChild(label);
        buildingOptions.appendChild(group);
      });
    }

    function createGrid() {
      gridContainer.innerHTML = "";
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.onclick = () => placeBuilding(cell, x, y);
          gridContainer.appendChild(cell);
        }
      }
    }

    function placeBuilding(cell, x, y) {
      if (!selectedType) return;

      if (selectedType === "eraser") {
        gridData[y][x] = "";
        cell.className = "cell";
        return;
      }

      gridData[y][x] = selectedType;
      cell.className = `cell ${selectedType}`;
    }

    function loadVillage(data) {
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const type = data?.[y]?.[x] || "";
          gridData[y][x] = type;
        }
      }
      updateGridVisual();
    }

    function updateGridVisual() {
      const cells = gridContainer.querySelectorAll(".cell");
      cells.forEach(cell => {
        const x = cell.dataset.x;
        const y = cell.dataset.y;
        const type = gridData[y][x];
        cell.className = "cell";
        if (type) cell.classList.add(type);
      });
    }

    async function saveVillage() {
      if (!currentUsername) return alert("No username set.");
      const ref = doc(db, "villages", currentUsername);
      await setDoc(ref, {
        owner: currentUsername,
        grid: gridData,
        power: calculatePower()
      });
      alert("Village saved!");
    }

    function calculatePower() {
      let attack = 0, defense = 0;
      for (let row of gridData) {
        for (let type of row) {
          if (type && buildingStats[type]) {
            attack += buildingStats[type].attack;
            defense += buildingStats[type].defense;
          }
        }
      }
      return { attack, defense };
    }

    async function loadIfExists() {
      if (!currentUsername) return;
      const ref = doc(db, "villages", currentUsername);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        loadVillage(snap.data().grid);
      }
    }

    document.getElementById("saveBtn").onclick = saveVillage;
    createBuildingButtons();
    createGrid();
    loadIfExists();
  </script>
</body>
</html>
