<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üèóÔ∏è Create Village</title>
  <style>
    body { font-family: Arial, sans-serif; background: #eef2f5; text-align: center; padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(16, 30px); gap: 2px; margin: auto; margin-top: 20px; }
    .cell { width: 30px; height: 30px; background: #fff; border: 1px solid #ccc; }
    .panel { margin-top: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .building-label { font-size: 0.75em; margin-top: 2px; text-align: center; max-width: 60px; }
    .building-option { display: flex; flex-direction: column; align-items: center; width: 60px; }
    .building { width: 30px; height: 30px; border: 2px solid black; cursor: pointer; }
    #saveBtn, #loadBtn { margin: 10px; padding: 10px 20px; font-size: 1em; }

    .wall { background: black; }
    .strongWall { background: orange; }
    .archerTower { background: red; }
    .trap { background: green; }
    .lightningStriker { background: blue; }
    .troopStructure { background: purple; }
    .eraser { background: white; position: relative; }
    .eraser::after {
      content: "‚úñ";
      position: absolute;
      color: black;
      font-size: 16px;
      top: 2px;
      left: 7px;
    }
  </style>
</head>
<body>
  <h1>üèóÔ∏è Build Your Village</h1>

  <div class="panel" id="buildingOptions"></div>
  <div class="grid" id="villageGrid"></div>
  <button id="saveBtn">üíæ Save Village</button>
  <button id="loadBtn">üîÑ Load Village</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const buildingStats = {
      wall: { attack: 0, defense: 2, cost: 0 },
      strongWall: { attack: 0, defense: 5, cost: 0 },
      archerTower: { attack: 4, defense: 1, cost: 0 },
      trap: { attack: 3, defense: 3, cost: 0 },
      lightningStriker: { attack: 6, defense: 1, cost: 0 },
      troopStructure: { attack: 5, defense: 2, cost: 0 }
    };

    const buildingTypes = [
      { type: "wall", name: "Wall" },
      { type: "strongWall", name: "Strong Wall" },
      { type: "archerTower", name: "Archer" },
      { type: "trap", name: "Trap" },
      { type: "lightningStriker", name: "Lightning" },
      { type: "troopStructure", name: "Troops" },
      { type: "eraser", name: "Erase" }
    ];

    let selectedType = null;
    const gridSize = 16;
    const gridData = Array(gridSize).fill().map(() => Array(gridSize).fill(""));

    const buildingOptions = document.getElementById("buildingOptions");
    const gridContainer = document.getElementById("villageGrid");

    function createBuildingButtons() {
      buildingTypes.forEach(b => {
        const wrapper = document.createElement("div");
        wrapper.className = "building-option";

        const div = document.createElement("div");
        div.className = `building ${b.type}`;
        div.title = b.name;
        div.onclick = () => selectedType = b.type;

        const label = document.createElement("div");
        label.className = "building-label";
        if (b.type !== "eraser" && buildingStats[b.type]) {
          label.innerHTML = `${b.name}<br>‚ìÇ $${buildingStats[b.type].cost}`;
        } else {
          label.textContent = b.name;
        }

        wrapper.appendChild(div);
        wrapper.appendChild(label);
        buildingOptions.appendChild(wrapper);
      });
    }

    function createGrid() {
      gridContainer.innerHTML = "";
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.onclick = () => placeBuilding(cell, x, y);
          gridContainer.appendChild(cell);
        }
      }
    }

    function placeBuilding(cell, x, y) {
      if (!selectedType) return;
      if (selectedType === "eraser") {
        gridData[y][x] = "";
        cell.className = "cell";
        return;
      }
      gridData[y][x] = selectedType;
      cell.className = `cell ${selectedType}`;
    }

    async function saveVillage() {
      const username = prompt("Enter your username:");
      const password = prompt("Enter your password:");
      if (!username || !password) return alert("Username and password required.");

      const userRef = doc(db, "users", username);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return alert("User not found.");

      const userData = userSnap.data();
      if (userData.password !== password) return alert("Incorrect password.");

      const villageRef = doc(db, "villages", username);
      await setDoc(villageRef, {
        owner: username,
        grid: gridData,
        power: calculatePower()
      });
      alert("Village saved!");
    }

    async function loadVillage() {
      const username = prompt("Enter your username:");
      const password = prompt("Enter your password:");
      if (!username || !password) return alert("Username and password required.");

      const userRef = doc(db, "users", username);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return alert("User not found.");

      const userData = userSnap.data();
      if (userData.password !== password) return alert("Incorrect password.");

      const villageRef = doc(db, "villages", username);
      const villageSnap = await getDoc(villageRef);
      if (!villageSnap.exists()) return alert("No saved village found.");

      const data = villageSnap.data();
      if (data.grid) {
        for (let y = 0; y < gridSize; y++) {
          for (let x = 0; x < gridSize; x++) {
            gridData[y][x] = data.grid[y][x] || "";
          }
        }
        updateGridVisual();
      }
    }

    function updateGridVisual() {
      const cells = gridContainer.querySelectorAll(".cell");
      cells.forEach(cell => {
        const x = cell.dataset.x;
        const y = cell.dataset.y;
        const type = gridData[y][x];
        cell.className = "cell";
        if (type) cell.classList.add(type);
      });
    }

    function calculatePower() {
      let attack = 0, defense = 0;
      for (let row of gridData) {
        for (let type of row) {
          if (type && buildingStats[type]) {
            attack += buildingStats[type].attack;
            defense += buildingStats[type].defense;
          }
        }
      }
      return { attack, defense };
    }

    createBuildingButtons();
    createGrid();
    document.getElementById("saveBtn").onclick = saveVillage;
    document.getElementById("loadBtn").onclick = loadVillage;
  </script>
</body>
</html>
