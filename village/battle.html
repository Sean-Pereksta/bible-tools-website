<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>‚öîÔ∏è Battle</title>
  <style>
    body { font-family: Arial, sans-serif; background: #eef2f5; margin: 0; padding: 0; display: flex; }
    #sidebar { width: 160px; background: #ddd; padding: 10px; border-right: 2px solid #aaa; }
    #grid { display: grid; grid-template-columns: repeat(16, 30px); gap: 2px; margin: 20px; }
    .cell { width: 30px; height: 30px; background: #fff; border: 1px solid #ccc; position: relative; }
    .wall { background: black; }
    .strongWall { background: orange; }
    .archerTower { background: red; }
    .trap { background: green; }
    .lightningStriker { background: blue; }
    .troopStructure { background: purple; }

    .health-bar {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 28px;
      height: 4px;
      background: #aaa;
    }
    .health-fill { height: 100%; background: limegreen; }

    .troop {
      background: gray;
      border: 2px solid black;
      width: 26px;
      height: 26px;
      margin: auto;
      border-radius: 50%;
    }

    .troop-tray button,
    #surrenderBtn {
      display: block;
      margin: 5px 0;
      padding: 6px;
      width: 100%;
      background: gray;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #resultPopup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 3px solid black;
      padding: 30px;
      text-align: center;
      z-index: 1000;
      border-radius: 10px;
    }

    #resultPopup h2 {
      margin-top: 0;
    }

    #resultPopup button {
      padding: 10px 20px;
      font-size: 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h4>üõ°Ô∏è Troops</h4>
    <div class="troop-tray">
      <button onclick="selectTroopType('base')">Base Troop</button>
    </div>
    <div><strong>Troops Left:</strong> <span id="troopCount">0</span></div>
    <button id="surrenderBtn" onclick="endBattle(false)">üè≥Ô∏è Surrender</button>
  </div>

  <div id="grid"></div>

  <div id="resultPopup">
    <h2 id="resultText">Result</h2>
    <button onclick="window.location.href='/bible-tools-website/village/villagelobby.html'">Return to Village Lobby</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const attacker = params.get("attacker");
    const defender = params.get("defender");

    const gridSize = 16;
    const gridElement = document.getElementById("grid");
    const healthMap = {};
    const troopUnits = [];
    let selectedTroopType = "base";
    let troopsLeft = 0;
    let archerInterval;
    let battleOver = false;

    const buildingHealth = {
      wall: 50,
      strongWall: 100,
      archerTower: 20,
      trap: 10,
      lightningStriker: 10,
      troopStructure: 10
    };

    const troopStats = {
      base: { hp: 20, damage: 3, range: 1, speed: 1 }
    };

    const enemyStructures = [];
    const archerTowers = [];
    const lightningTowers = [];
    const trapTowers = [];


    function selectTroopType(type) {
      selectedTroopType = type;
    }

    function renderHealth(cell, key, value) {
      let healthBar = cell.querySelector(".health-bar");
      if (!healthBar) {
        healthBar = document.createElement("div");
        healthBar.className = "health-bar";
        const fill = document.createElement("div");
        fill.className = "health-fill";
        healthBar.appendChild(fill);
        cell.appendChild(healthBar);
      }
      const fill = healthBar.querySelector(".health-fill");
      const full = healthMap[key].max;
      fill.style.width = `${(value / full) * 100}%`;
    }

    function getClosestTarget(x, y) {
      let minDist = Infinity;
      let closest = null;
      for (const s of enemyStructures) {
        const key = `${s.x},${s.y}`;
        if (healthMap[key]?.current > 0) {
          const dx = s.x - x;
          const dy = s.y - y;
          const dist = Math.abs(dx) + Math.abs(dy);
          if (dist < minDist) {
            minDist = dist;
            closest = s;
          }
        }
      }
      return closest;
    }

    function spawnTroop(x, y) {
      if (troopsLeft <= 0 || battleOver) return;

        const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
        if (!cell || cell.classList.length > 1) return; // Prevent placing on structures

      const troop = {
        x, y,
        hp: troopStats.base.hp,
        damage: troopStats.base.damage,
        range: troopStats.base.range,
        speed: troopStats.base.speed,
        interval: null,
        div: null
      };

      const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
      const tDiv = document.createElement("div");
      tDiv.className = "troop";
      cell.appendChild(tDiv);
      troop.div = tDiv;
      troopUnits.push(troop);

      troopsLeft--;
      document.getElementById("troopCount").textContent = troopsLeft;

      troop.interval = setInterval(() => {
        if (battleOver) return;

        const target = getClosestTarget(troop.x, troop.y);
        if (!target) {
          clearInterval(troop.interval);
          endBattle(true);
          return;
        }

        const dx = target.x - troop.x;
        const dy = target.y - troop.y;
        const distance = Math.abs(dx) + Math.abs(dy);
        const inRange = distance <= troop.range;

        const currentCell = document.querySelector(`.cell[data-x="${troop.x}"][data-y="${troop.y}"]`);
        if (currentCell) currentCell.innerHTML = "";

        if (inRange) {
          const key = `${target.x},${target.y}`;
          const targetHealth = healthMap[key];
          if (targetHealth && targetHealth.current > 0) {
          targetHealth.current -= troop.damage;
          if (targetHealth.current <= 0) {
            targetHealth.current = 0;
            delete healthMap[key];
            const targetCell = document.querySelector(`.cell[data-x="${target.x}"][data-y="${target.y}"]`);
            if (targetCell) {
              targetCell.className = "cell";
              targetCell.innerHTML = "";
            }
            checkVictoryCondition();
          } else {
            const targetCell = document.querySelector(`.cell[data-x="${target.x}"][data-y="${target.y}"]`);
            renderHealth(targetCell, key, targetHealth.current);
          }
        }

        } else {
          troop.x += Math.sign(dx);
          troop.y += Math.sign(dy);
        }

        const newCell = document.querySelector(`.cell[data-x="${troop.x}"][data-y="${troop.y}"]`);
        if (newCell) {
          const newDiv = document.createElement("div");
          newDiv.className = "troop";
          newCell.appendChild(newDiv);
          troop.div = newDiv;
        }
      }, 1000);
    }

    function createGrid() {
      gridElement.innerHTML = "";
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.onclick = () => spawnTroop(x, y);
          gridElement.appendChild(cell);
        }
      }
    }

    function checkVictoryCondition() {
      const remaining = Object.values(healthMap).filter(h => h.current > 0);
      if (remaining.length === 0) {
        endBattle(true);
      }
    }

    function endBattle(victory) {
      battleOver = true;
      clearInterval(archerInterval);
      troopUnits.forEach(t => clearInterval(t.interval));
      document.getElementById("resultText").textContent = victory ? "üèÜ Victory!" : "‚ùå Defeat!";
      document.getElementById("resultPopup").style.display = "block";
    }

   function startArcherAttacks() {
  archerInterval = setInterval(() => {
    for (const tower of archerTowers) {
      const { x, y } = tower;
      const key = `${x},${y}`;
      const towerHealth = healthMap[key];

      if (!towerHealth || towerHealth.current <= 0) continue; // Skip dead towers

      let closest = null;
      let minDist = Infinity;

      for (const t of troopUnits) {
        if (t.hp <= 0) continue;

        const dx = t.x - x;
        const dy = t.y - y;
        const dist = Math.abs(dx) + Math.abs(dy);

        if (dist <= 5 && dist < minDist) {
          minDist = dist;
          closest = t;
        }
      }

      if (closest) {
        closest.hp -= 5;

        const cell = document.querySelector(`.cell[data-x="${closest.x}"][data-y="${closest.y}"]`);
        if (cell) {
          // Flash red when hit
          cell.style.backgroundColor = 'red';
          setTimeout(() => {
            cell.style.backgroundColor = '';
          }, 100);
        }

        if (closest.hp <= 0) {
          if (cell) cell.innerHTML = "";
          clearInterval(closest.interval);
        }
      }
    }
  }, 1500);
}
  function startLightningAttacks(lightningTowers) {
  setInterval(() => {
    if (battleOver) return;

    for (const tower of lightningTowers) {
      const { x: lx, y: ly } = tower;
      const key = `${lx},${ly}`;
      const towerHealth = healthMap[key];

      if (!towerHealth || towerHealth.current <= 0) continue; // ‚úÖ Skip dead towers

      for (const troop of troopUnits) {
        if (troop.hp <= 0) continue;

        const dx = troop.x - lx;
        const dy = troop.y - ly;
        const distance = Math.abs(dx) + Math.abs(dy);

        if (distance <= 3) {
          troop.hp -= 1;

          const troopCell = document.querySelector(`.cell[data-x="${troop.x}"][data-y="${troop.y}"]`);
          if (troopCell) {
            troopCell.style.backgroundColor = 'yellow';
            setTimeout(() => {
              troopCell.style.backgroundColor = '';
            }, 100);
          }

          if (troop.hp <= 0) {
            if (troopCell) troopCell.innerHTML = "";
            clearInterval(troop.interval);
          }
        }
      }
    }
  }, 400);
}
function startTrapAttacks(trapTowers) {
  setInterval(() => {
    if (battleOver) return;

    for (const trap of trapTowers) {
      const { x: tx, y: ty } = trap;
      const key = `${tx},${ty}`;
      const trapHealth = healthMap[key];

      if (!trapHealth || trapHealth.current <= 0) continue; // Skip dead traps

      for (const troop of troopUnits) {
        if (troop.hp <= 0) continue;

        const dx = troop.x - tx;
        const dy = troop.y - ty;
        const distance = Math.sqrt(dx * dx + dy * dy); // Use Euclidean distance for 1.5 radius

        if (distance <= 1.5) {
          troop.hp -= 10;

          const cell = document.querySelector(`.cell[data-x="${troop.x}"][data-y="${troop.y}"]`);
          if (cell) {
            cell.style.backgroundColor = 'orange';
            setTimeout(() => {
              cell.style.backgroundColor = '';
            }, 100);
          }

          if (troop.hp <= 0) {
            if (cell) cell.innerHTML = "";
            clearInterval(troop.interval);
          }
        }
      }
    }
  }, 1000); // Adjust tick speed if needed
}



    async function init() {
      if (!attacker || !defender) return alert("Invalid URL");

      const attackerRef = doc(db, "villages", attacker);
      const defenderRef = doc(db, "villages", defender);
      const [attackerSnap, defenderSnap] = await Promise.all([
        getDoc(attackerRef),
        getDoc(defenderRef)
      ]);

      const attackerData = attackerSnap.data();
      const defenderData = defenderSnap.data();

      const troopBuildings = attackerData.grid?.filter(t => t.type === "troopStructure").length || 0;
      troopsLeft = troopBuildings * 5;
      document.getElementById("troopCount").textContent = troopsLeft;

      createGrid();

      for (const b of defenderData.grid || []) {
        const key = `${b.x},${b.y}`;
        const cell = document.querySelector(`.cell[data-x="${b.x}"][data-y="${b.y}"]`);
        if (!cell) continue;

        cell.classList.add(b.type);
        const baseHP = buildingHealth[b.type] || 10;
        healthMap[key] = { current: baseHP, max: baseHP };
        renderHealth(cell, key, baseHP);

        enemyStructures.push({ ...b });
        if (b.type === "archerTower") archerTowers.push({ x: b.x, y: b.y });
        if (b.type === "lightningStriker") lightningTowers.push({ x: b.x, y: b.y });
        if (b.type === "trap") trapTowers.push({ x: b.x, y: b.y });

      }

      startArcherAttacks();
      startLightningAttacks(lightningTowers);
      startTrapAttacks(trapTowers);

    }

    init();
  </script>
</body>
</html>
