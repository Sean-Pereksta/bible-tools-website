<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>‚öîÔ∏è Battle</title>
  <style>
    body { font-family: Arial, sans-serif; background: #eef2f5; margin: 0; padding: 0; display: flex; }
    #sidebar { width: 160px; background: #ddd; padding: 10px; border-right: 2px solid #aaa; }
    #grid { display: grid; grid-template-columns: repeat(16, 30px); gap: 2px; margin: 20px; }
    .cell { width: 30px; height: 30px; background: #fff; border: 1px solid #ccc; position: relative; }
    .wall { background: black; }
    .strongWall { background: orange; }
    .archerTower { background: red; }
    .trap { background: green; }
    .lightningStriker { background: blue; }
    .troopStructure { background: purple; }

    .health-bar, .troop-health {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 28px;
      height: 4px;
      background: #aaa;
    }
    .health-fill { height: 100%; background: limegreen; }

    .troop {
      background: gray;
      border: 2px solid black;
      width: 26px;
      height: 26px;
      margin: auto;
      border-radius: 50%;
      position: relative;
    }

    .troop-tray button,
    #surrenderBtn {
      display: block;
      margin: 5px 0;
      padding: 6px;
      width: 100%;
      background: gray;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #resultPopup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 3px solid black;
      padding: 30px;
      text-align: center;
      z-index: 1000;
      border-radius: 10px;
    }

    #resultPopup h2 {
      margin-top: 0;
    }

    #resultPopup button {
      padding: 10px 20px;
      font-size: 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { /* your config */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const attacker = params.get("attacker");
const defender = params.get("defender");

const gridSize = 16;
const gridElement = document.getElementById("grid");
const troopStats = { base: { hp: 20, damage: 3, range: 1, speed: 1 } };
const buildingHealth = { wall: 50, strongWall: 150, archerTower: 20, trap: 10, lightningStriker: 10, troopStructure: 10 };
const healthMap = {};
const troopUnits = [];
const archerTowers = [], traps = [], lightTowers = [];
let selectedTroopType = "base", troopsLeft = 0, battleOver = false;

function createGrid() {
  for (let y = 0; y < gridSize; y++) {
    for (let x = 0; x < gridSize; x++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.x = x;
      cell.dataset.y = y;
      cell.onclick = () => spawnTroop(x, y);
      gridElement.appendChild(cell);
    }
  }
}

function renderHealth(cell, key, value) {
  if (value <= 0 && cell) return cell.className = "cell";
  let bar = cell.querySelector(".health-bar") || cell.querySelector(".troop-health");
  if (!bar) {
    bar = document.createElement("div");
    bar.className = cell.classList.contains("troop") ? "troop-health" : "health-bar";
    const fill = document.createElement("div");
    fill.className = "health-fill";
    bar.appendChild(fill);
    cell.appendChild(bar);
  }
  const fill = bar.querySelector(".health-fill");
  const full = healthMap[key]?.max || 20;
  fill.style.width = `${(value / full) * 100}%`;
}

function spawnTroop(x, y) {
  if (troopsLeft <= 0 || battleOver) return;
  const troop = { x, y, hp: 20, ...troopStats.base };
  const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
  const div = document.createElement("div");
  div.className = "troop";
  cell.appendChild(div);
  renderHealth(div, `${x},${y}`, troop.hp);
  troop.div = div;
  troopsLeft--;
  troopUnits.push(troop);
  troop.interval = setInterval(() => moveTroop(troop), 1000);
}

function moveTroop(troop) {
  const target = findTarget(troop.x, troop.y);
  if (!target) return endBattle(true);
  const dx = Math.sign(target.x - troop.x), dy = Math.sign(target.y - troop.y);
  if (Math.abs(dx) + Math.abs(dy) <= troop.range) {
    const key = `${target.x},${target.y}`;
    if (healthMap[key]) {
      healthMap[key].current -= troop.damage;
      if (healthMap[key].current <= 0) {
        delete healthMap[key];
        document.querySelector(`.cell[data-x="${target.x}"][data-y="${target.y}"]`).className = "cell";
      } else {
        renderHealth(document.querySelector(`.cell[data-x="${target.x}"][data-y="${target.y}"]`), key, healthMap[key].current);
      }
    }
  } else {
    troop.x += dx;
    troop.y += dy;
    updateTroopPosition(troop);
  }
  renderHealth(troop.div, `${troop.x},${troop.y}`, troop.hp);
  checkVictoryCondition();
}

function updateTroopPosition(troop) {
  const cell = document.querySelector(`.cell[data-x="${troop.x}"][data-y="${troop.y}"]`);
  if (cell) {
    cell.innerHTML = "";
    cell.appendChild(troop.div);
  }
}

function findTarget(x, y) {
  let best = null, dist = Infinity;
  for (const key in healthMap) {
    const [tx, ty] = key.split(",").map(Number);
    const d = Math.abs(tx - x) + Math.abs(ty - y);
    if (healthMap[key].current > 0 && d < dist) {
      best = { x: tx, y: ty };
      dist = d;
    }
  }
  return best;
}

function checkVictoryCondition() {
  if (Object.keys(healthMap).length === 0) endBattle(true);
}

function endBattle(victory) {
  battleOver = true;
  troopUnits.forEach(t => clearInterval(t.interval));
  document.body.insertAdjacentHTML('beforeend', `<div id="resultPopup"><h2>${victory ? 'üèÜ Victory!' : '‚ùå Defeat!'}</h2><button onclick="location.href='/bible-tools-website/village/villagelobby.html'">Return</button></div>`);
}

function aoeAttacks() {
  setInterval(() => {
    for (const { x, y } of lightTowers) {
      troopUnits.forEach(t => {
        if (!t.hp || battleOver) return;
        const dist = Math.abs(t.x - x) + Math.abs(t.y - y);
        if (dist <= 3) t.hp--;
      });
    }
  }, 400);
  setInterval(() => {
    for (const { x, y } of traps) {
      troopUnits.forEach(t => {
        if (!t.hp || battleOver) return;
        const dist = Math.abs(t.x - x) + Math.abs(t.y - y);
        if (dist === 1) t.hp -= 10;
      });
    }
  }, 1500);
}

async function init() {
  const attackerRef = doc(db, "villages", attacker);
  const defenderRef = doc(db, "villages", defender);
  const [attackerSnap, defenderSnap] = await Promise.all([getDoc(attackerRef), getDoc(defenderRef)]);
  const troopStructures = attackerSnap.data().grid.filter(b => b.type === "troopStructure").length;
  troopsLeft = troopStructures * 5;
  createGrid();
  for (const b of defenderSnap.data().grid) {
    const key = `${b.x},${b.y}`;
    const cell = document.querySelector(`.cell[data-x="${b.x}"][data-y="${b.y}"]`);
    cell.classList.add(b.type);
    healthMap[key] = { current: buildingHealth[b.type] || 10, max: buildingHealth[b.type] || 10 };
    if (b.type === "archerTower") archerTowers.push(b);
    if (b.type === "trap") traps.push(b);
    if (b.type === "lightningStriker") lightTowers.push(b);
    renderHealth(cell, key, healthMap[key].current);
  }
  aoeAttacks();
}
init();
</script>
<div id="sidebar">
  <h4>üõ°Ô∏è Troops</h4>
  <div class="troop-tray"><button onclick="selectTroopType('base')">Base Troop</button></div>
  <div><strong>Troops Left:</strong> <span id="troopCount">0</span></div>
  <button id="surrenderBtn" onclick="endBattle(false)">üè≥Ô∏è Surrender</button>
</div>
<div id="grid"></div>
</body>
</html>
