<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üè∞ Tribes Page</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; text-align: center; padding: 20px; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    .village-box { background: #eee; padding: 10px; margin: 10px 0; border-radius: 6px; cursor: pointer; }
    .tribe-power { margin-top: 30px; background: #fafafa; padding: 10px; border-radius: 6px; }
    button { margin: 5px; padding: 10px 15px; border: none; background: #3498db; color: white; border-radius: 5px; cursor: pointer; }
    input { padding: 10px; margin: 5px; width: 200px; }

    #previewPopup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border: 2px solid #333;
      border-radius: 10px;
      z-index: 1000;
    }

    #previewPopup button {
      float: right;
      font-size: 18px;
      background: none;
      color: black;
    }

    #previewGrid {
      display: grid;
      grid-template-columns: repeat(16, 10px);
      gap: 1px;
      margin-top: 10px;
    }

    #previewGrid div {
      width: 10px;
      height: 10px;
      border: 1px solid #ccc;
      background: #fff;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUsername = null;

    const buildingClassMap = {
      wall: 'black',
      strongWall: 'orange',
      archerTower: 'red',
      trap: 'green',
      lightningStriker: 'blue',
      troopStructure: 'purple'
    };

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginBtn").onclick = async () => {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();

        const userRef = doc(db, "users", username);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const data = userSnap.data();
          if (data.password === password) {
            currentUsername = username;
            loadVillagePage();
          } else {
            alert("Incorrect password.");
          }
        } else {
          alert("Username not found.");
        }
      };
    });

    async function loadVillagePage() {
      document.getElementById("loginSection").style.display = "none";
      const villagesCol = collection(db, "villages");
      const snapshot = await getDocs(villagesCol);
      const container = document.getElementById("villageList");
      container.innerHTML = "<h2>üèòÔ∏è Active Villages</h2>";
      let hasVillage = false;

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "village-box";
        div.innerHTML = `<strong>${docSnap.id}</strong><br>Owner: ${data.owner}<br>Power: ${JSON.stringify(data.power)}`;

        div.onclick = () => {
          const grid = data.grid || [];
          showVillagePreview(grid);
        };

        if (data.owner !== currentUsername) {
          const attackBtn = document.createElement("button");
          attackBtn.textContent = "‚öîÔ∏è Attack";
          attackBtn.onclick = (e) => {
            e.stopPropagation(); // Prevent preview from opening when attack clicked
            window.location.href = "#attack-placeholder";
          };
          div.appendChild(attackBtn);
        } else {
          hasVillage = true;
        }

        container.appendChild(div);
      });

      const actionBtn = document.createElement("button");
      actionBtn.textContent = hasVillage ? "üè∞ Work on Village" : "üõ†Ô∏è Create Village";
      actionBtn.onclick = () => window.location.href = "/bible-tools-website/village/createvillage.html";
      container.appendChild(actionBtn);

      loadTribePower();
    }

    function loadTribePower() {
      const ref = doc(db, "global", "tribePower");
      onSnapshot(ref, (snap) => {
        const data = snap.data();
        const container = document.getElementById("tribePower");
        container.innerHTML = `<h2>üî± Tribe Power Rankings</h2>` +
          Object.entries(data || {}).map(([tribe, power]) => `<div>${tribe}: ${power} pts</div>`).join("");
      });
    }

    function showVillagePreview(grid) {
      const popup = document.getElementById("previewPopup");
      const previewGrid = document.getElementById("previewGrid");
      previewGrid.innerHTML = "";

      const gridSize = 16;
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const div = document.createElement("div");
          const match = grid.find(tile => tile.x === x && tile.y === y);
          if (match && buildingClassMap[match.type]) {
            div.style.background = buildingClassMap[match.type];
          }
          previewGrid.appendChild(div);
        }
      }

      popup.style.display = "block";
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>üõ°Ô∏è Tribes of Israel</h1>
    <div id="loginSection">
      <input id="username" type="text" placeholder="Username" />
      <input id="password" type="password" placeholder="Password" />
      <button id="loginBtn">üîê Login</button>
    </div>
    <div id="villageList"></div>
    <div id="tribePower" class="tribe-power"></div>
  </div>

  <!-- Village Preview Popup -->
  <div id="previewPopup">
    <button onclick="document.getElementById('previewPopup').style.display='none'">‚ùå</button>
    <h3>üèòÔ∏è Village Layout</h3>
    <div id="previewGrid"></div>
  </div>
</body>
</html>
