<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ™‹â€â™‚ï¸ My Account</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
    }
    input, button {
      margin: 10px;
      padding: 10px;
      font-size: 1em;
    }
    .badge {
      font-size: 1.2em;
      margin-top: 10px;
    }
    .prayer-box {
      border: 1px solid #ccc;
      margin: 5px;
      padding: 10px;
      border-radius: 5px;
    }
    .comments-box {
      border: 1px solid #ccc;
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      max-height: 150px;
      overflow-y: auto;
      text-align: left;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs,
      addDoc, orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7twY7z31ucB6pGA8JC_HrVMZhA8lNaJA",
      authDomain: "bible-game-246c0.firebaseapp.com",
      projectId: "bible-game-246c0",
      storageBucket: "bible-game-246c0.appspot.com",
      messagingSenderId: "959619818996",
      appId: "1:959619818996:web:5a9fbf492e23c765e445a1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Grab stored username or set default
    let username = localStorage.getItem("username") || "";

    // Login function
    window.login = async function () {
      const inputUser = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      const userQuery = query(collection(db, "users"), where("username", "==", inputUser));
      const userSnap = await getDocs(userQuery);
      if (userSnap.empty) return alert("âŒ Username not found.");

      let userData = null;
      userSnap.forEach(doc => {
        if (doc.data().password === password) {
          userData = { id: doc.id, ...doc.data() };
        }
      });

      if (!userData) return alert("âŒ Incorrect password.");

      // Set global + persistent username
      username = inputUser;
      localStorage.setItem("username", username);

      loadAccountData(userData);
    };

    // Load account details
    async function loadAccountData(userData) {
      document.getElementById("account").style.display = "block";
      document.getElementById("displayUser").innerText = username;

      // Wins and League display
      document.getElementById("wins").innerText = userData.wins || 0;
      let badge = "ğŸ¥‰ Bronze";
      if (userData.wins >= 5) badge = "ğŸ¥ˆ Silver";
      if (userData.wins >= 10) badge = "ğŸ¥‡ Gold";
      if (userData.wins >= 20) badge = "ğŸ’ Blue Platinum";
      if (userData.wins >= 30) badge = "ğŸ”´ Ruby";
      document.getElementById("league").innerText = badge;

      loadComments();
      loadPrayerLog();
    }

    // Load comments
    async function loadComments() {
      const notesQuery = query(collection(db, "notes"), where("name", "==", username));
      const notesSnap = await getDocs(notesQuery);
      document.getElementById("comments").innerText = notesSnap.size;

      const commentsBox = document.getElementById("commentsBox");
      commentsBox.innerHTML = "";
      notesSnap.forEach(doc => {
        const note = doc.data();
        const p = document.createElement("p");
        p.innerText = `${note.book} ${note.chapter}: ${note.note}`;
        commentsBox.appendChild(p);
      });
    }

    // Save a prayer request
    window.savePrayer = async function () {
      if (!username) {
        alert("âŒ You're not logged in. Please log in first.");
        return;
      }

      const prayer = document.getElementById("prayerInput").value.trim();
      if (!prayer) return;

      const today = new Date().toISOString().split('T')[0];
      await addDoc(collection(db, "prayers"), {
        user: username,
        text: prayer,
        date: today
      });

      document.getElementById("prayerInput").value = "";
      loadPrayerLog();
    };

    // Load prayer log
    window.loadPrayerLog = async function (offset = 0) {
      const prayerQuery = query(
        collection(db, "prayers"),
        where("user", "==", username),
        orderBy("date", "desc")
      );
      const snap = await getDocs(prayerQuery);
      const prayers = [];
      snap.forEach(doc => prayers.push(doc.data()));
      const container = document.getElementById("prayerLog");
      container.innerHTML = "";

      const start = offset * 5;
      const page = prayers.slice(start, start + 5);

      page.forEach(p => {
        const box = document.createElement("div");
        box.className = "prayer-box";
        box.innerText = `${p.date}: ${p.text}`;
        container.appendChild(box);
      });

      document.getElementById("pageNav").innerHTML = `
        <button onclick="loadPrayerLog(${offset - 1})" ${offset === 0 ? 'disabled' : ''}>â¬…ï¸ Back</button>
        <button onclick="loadPrayerLog(${offset + 1})" ${(start + 5) >= prayers.length ? 'disabled' : ''}>Next â¡ï¸</button>
      `;
    };
  </script>
</head>
<body>
  <div class="container">
    <h1>ğŸ™‹â€â™‚ï¸ My Account</h1>
    <input type="text" id="username" placeholder="Username"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Log In</button>

    <div id="account" style="display:none;">
      <h2>Welcome, <span id="displayUser"></span></h2>
      <p>ğŸ† Wins: <span id="wins">0</span></p>
      <p class="badge">League: <span id="league">ğŸ¥‰ Bronze</span></p>
      <p>ğŸ’¬ Comments Posted: <span id="comments">0</span></p>
      <div class="comments-box" id="commentsBox"></div>

      <h3>ğŸ™ Prayer Journal</h3>
      <input type="text" id="prayerInput" placeholder="Add prayer request...">
      <button onclick="savePrayer()">Save Prayer</button>
      <div id="prayerLog"></div>
      <div id="pageNav"></div>
    </div>
  </div>
</body>
</html>


